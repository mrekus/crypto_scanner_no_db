<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wallet Calculator</title>
<style>
:root{
    --bg:#f0f2f5;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#4CAF50;
    --accent-hover:#137e14;
    --danger:#f44336;
}
html,body{height:100%;margin:0;}
body{
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:40px 24px;
}
.container{
    width:min(1600px,96%);
    max-width:1600px;
    background:var(--card);
    border-radius:12px;
    padding:36px;
    box-shadow:0 10px 30px rgba(16,24,40,0.08);
    display:flex;
    flex-direction:column;
    gap:24px;
    align-items:center;
}
h1{font-size:26px;margin:0;text-align:center;}
form{
    display:flex;
    flex-direction:column;
    gap:20px;
    width:100%;
    max-width:1000px;
    align-items:stretch;
}
input[type="text"], input[type="date"], select{
    padding:16px;
    border-radius:12px;
    border:1px solid #ccc;
    font-size:16px;
    width:100%;
    max-width:800px;
    box-sizing:border-box;
}
button{
    padding:16px 0;
    border-radius:12px;
    border:0;
    background:var(--accent);
    color:#fff;
    font-weight:700;
    font-size:16px;
    cursor:pointer;
    width:100%;
    max-width:800px;
}
button:hover{background:var(--accent-hover);}
.results{
    display:flex;
    flex-direction:column;
    gap:16px;
    width:100%;
    max-width:1000px;
}
.results .transactions {
    max-height: 500px;
    width: 100%;
    overflow-y: auto;
    background: #111;
    color: #0f0;
    font-family: monospace;
    padding: 12px;
    border-radius: 12px;
    white-space: pre-wrap;
}
.tokens-table {
    width:100%;
    border-collapse: collapse;
    font-family: system-ui, Roboto, "Helvetica Neue", Arial, monospace;
    margin-top:10px;
}
.tokens-table th, .tokens-table td {
    border:1px solid #ddd;
    padding:8px 10px;
    text-align:left;
    vertical-align:top;
}
.tokens-table th {
    background:#f9f9f9;
    font-weight:700;
}
.toast{
    position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 20px;border-radius:12px;color:#fff;font-weight:700;display:none;z-index:1300;
}
.toast.error{background:var(--danger)}
.toast.success{background:var(--accent)}
.visually-hidden{
    position:absolute!important;
    height:1px;width:1px;
    overflow:hidden;clip:rect(1px,1px,1px,1px);
    white-space:nowrap;border:0;padding:0;margin:-1px;
}
.add-wallet-btn {
    display: inline-block;
    background-color: #4CAF50;
    color: white;
    font-weight: bold;
    border: none;
    padding: 10px 16px;
    margin-top: 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease;
}
.add-wallet-btn:hover {
    background-color: #137e14;
}
</style>
</head>
<body>
<div class="container">
    <h1>Wallet Calculator</h1>
    <form id="walletForm">
        <div id="walletInputs">
            <label>
                <input type="text" name="wallet" placeholder="Wallet Address" required />
            </label>
        </div>

        <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="multiWalletCheckbox" />
            <span>Enable Multi-Wallet Mode</span>
        </label>
        <button type="button" id="addWalletBtn" class="add-wallet-btn" style="display:none;">Add wallet</button>

        <label>
            <input type="date" name="start_date" required />
        </label>
        <label>
            <input type="date" name="end_date" required />
        </label>
        <label>
            <select name="timezone" required>
                <option value="">Select Timezone</option>
                <option value="UTC">UTC</option>
                <option value="Europe/Vilnius">Europe/Vilnius</option>
                <option value="Europe/London">Europe/London</option>
                <option value="Europe/Berlin">Europe/Berlin</option>
                <option value="America/New_York">America/New_York</option>
                <option value="America/Los_Angeles">America/Los_Angeles</option>
                <option value="Asia/Tokyo">Asia/Tokyo</option>
                <option value="Asia/Singapore">Asia/Singapore</option>
                <option value="Australia/Sydney">Australia/Sydney</option>
            </select>
        </label>

        <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="fifoCheckbox" name="fifo" value="true" />
            <span>Enable FIFO Calculations</span>
        </label>

        <button type="submit">Check Wallet</button>
    </form>

    <div class="results" id="results">
        <div><strong>Starting Balance:</strong> <span id="startBalance">-</span></div>
        <div><strong>Ending Balance:</strong> <span id="endBalance">-</span></div>
        <div><strong>Gas Used:</strong> <span id="gasUsed">-</span></div>

        <div id="fifoSummaryContainer" style="display:none;">
            <div><strong>FIFO Summary:</strong></div>
            <table class="tokens-table" id="fifoSummaryTable">
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Sold Amount</th>
                        <th>Sold Value (EUR)</th>
                        <th>Profit (EUR)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div><strong>Tokens:</strong></div>
        <table class="tokens-table" id="tokensTable" aria-describedby="tokens-table-desc">
            <caption id="tokens-table-desc" class="visually-hidden">Token balances — start, end, and difference values</caption>
            <thead>
                <tr>
                    <th>Token (name — contract)</th>
                    <th>Start Balance</th>
                    <th>Start Value</th>
                    <th>End Balance</th>
                    <th>End Value</th>
                    <th>Balance Δ</th>
                    <th>Value Δ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="fifoSalesContainer" style="display:none;">
            <div><strong>FIFO Sales:</strong></div>
        </div>

        <div><strong>Events / Logs:</strong></div>
        <div class="transactions" id="eventsLog">No events</div>

        <div><strong id="outgoingHeader">Outgoing Transactions:</strong></div>
        <div class="transactions" id="transactionsOutgoing">No data</div>

        <div><strong id="incomingHeader">Incoming Transactions:</strong></div>
        <div class="transactions" id="transactionsIncoming">No data</div>
    </div>

    <div style="margin-top:40px; width:100%; max-width:800px; display:flex; flex-direction:column; gap:12px;">
        <label for="aiPrompt"></label><textarea id="aiPrompt" placeholder="Enter prompt here..." style="padding:16px; border-radius:12px; border:1px solid #ccc; width:100%; resize:vertical; min-height:80px;"></textarea>
    <button type="button" id="sendAiBtn">Ask AI</button>
    <div id="aiResponse" class="transactions" style="whitespace: pre-wrap; font-family: monospace; overflow-wrap: break-word; background:#222; color:#0f0; min-height:60px;"></div>
</div>

</div>

<div id="toast" class="toast"></div>

<script>
function formatTsWithTimezone(tsSeconds, timezone) {
    const tz = timezone || 'UTC';
    const d = new Date(Number(tsSeconds) * 1000);
    return d.toLocaleString(undefined, {
        timeZone: tz,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
}

const form = document.getElementById('walletForm');
const startBalanceEl = document.getElementById('startBalance');
const endBalanceEl = document.getElementById('endBalance');
const gasEl = document.getElementById('gasUsed');
const eventsLogEl = document.getElementById('eventsLog');
const transactionsOutgoingEl = document.getElementById('transactionsOutgoing');
const transactionsIncomingEl = document.getElementById('transactionsIncoming');
const tokensTableBody = document.getElementById('tokensTable').querySelector('tbody');
const toastEl = document.getElementById('toast');
const outgoingHeader = document.getElementById('outgoingHeader');
const incomingHeader = document.getElementById('incomingHeader');
const fifoSalesContainer = document.getElementById('fifoSalesContainer');
const fifoSummaryContainer = document.getElementById('fifoSummaryContainer');
const fifoSummaryBody = document.getElementById('fifoSummaryTable').querySelector('tbody');

function showToast(msg,type='error',ms=2500){
    toastEl.textContent=msg;
    toastEl.className='toast '+(type==='success'?'success':'error');
    toastEl.style.display='block';
    setTimeout(()=> toastEl.style.display='none', ms);
}

function shortAddr(addr){
    if(!addr || typeof addr !== 'string') return addr || '';
    if(addr.length <= 12) return addr;
    return addr.slice(0,6) + '…' + addr.slice(-4);
}

function formatNumberForDisplay(v){
    if(v === undefined || v === null) return '-';
    const n = (typeof v === 'number') ? v : parseFloat(String(v));
    if(isNaN(n)) return String(v);
    if(n === 0) return '0';
    if(Math.abs(n) < 0.000001) return n.toExponential();
    return n.toLocaleString(undefined, {maximumFractionDigits: 8, hour12: false});
}

function formatEuro(v){
    if(v === undefined || v === null) return '-';
    if(typeof v === 'number') return '€' + Number(v).toFixed(4);
    const parsed = parseFloat(String(v));
    if(!isNaN(parsed)) return '€' + parsed.toFixed(4);
    return String(v);
}

function computeDelta(a,b){
    const aNum = parseFloat(a)||0;
    const bNum = parseFloat(b)||0;
    return bNum - aNum;
}

const today = new Date();
today.setDate(today.getDate() - 1);
const maxDate = today.toISOString().split('T')[0];
document.querySelectorAll('input[type="date"]').forEach(el => el.max = maxDate);

const multiWalletCheckbox = document.getElementById('multiWalletCheckbox');
const walletInputs = document.getElementById('walletInputs');
const addWalletBtn = document.getElementById('addWalletBtn');

multiWalletCheckbox.addEventListener('change', () => {
    if (multiWalletCheckbox.checked) {
        addWalletBtn.style.display = 'inline-block';
        walletInputs.innerHTML = '';
        const label = document.createElement('label');
        label.innerHTML = `<input type="text" name="wallets" placeholder="Wallet Address" required />`;
        walletInputs.appendChild(label);
    } else {
        addWalletBtn.style.display = 'none';
        walletInputs.innerHTML = `<label><input type="text" name="wallet" placeholder="Wallet Address" required /></label>`;
    }
});

addWalletBtn.addEventListener('click', (e) => {
    e.preventDefault();
    const label = document.createElement('label');
    label.innerHTML = `<input type="text" name="wallets" placeholder="Wallet Address" required />`;
    walletInputs.appendChild(label);
});

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    startBalanceEl.textContent = 'Loading...';
    endBalanceEl.textContent = 'Loading...';
    gasEl.textContent = 'Loading...';
    eventsLogEl.textContent = 'Loading...';
    transactionsOutgoingEl.textContent = 'Loading...';
    transactionsIncomingEl.textContent = 'Loading...';
    tokensTableBody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
    fifoSalesContainer.style.display = 'none';
    fifoSummaryContainer.style.display = 'none';

    const fifoChecked = document.getElementById('fifoCheckbox').checked;
    const walletEls = [...walletInputs.querySelectorAll('input[name="wallet"], input[name="wallets"]')];
    const wallets = walletEls.map(i => (i.value || '').trim()).filter(Boolean);
    if (wallets.length === 0) {
        showToast('Enter at least one wallet address');
        return;
    }

    const params = new URLSearchParams();
    params.set('wallets', wallets.join(','));
    params.set('start_date', form.querySelector('input[name="start_date"]').value);
    params.set('end_date', form.querySelector('input[name="end_date"]').value);
    params.set('timezone', form.querySelector('select[name="timezone"]').value || 'UTC');
    if (fifoChecked) params.set('fifo', 'true');

    try {
        const evtSource = new EventSource('/check?' + params.toString());

        evtSource.onmessage = function(event){
            try {
                const data = JSON.parse(event.data);
                if(data.type === 'log'){
                    eventsLogEl.textContent += data.msg + '\n';
                    eventsLogEl.scrollTop = eventsLogEl.scrollHeight;
                    return;
                }
                if(data.type === 'result'){
                    const res = data.data;
                    window.lastWalletResult = res; // store result for AI
                    const tz = form.querySelector('select[name="timezone"]').value || 'UTC';
                    const startEth = res.starting_balance?.eth ?? 0;
                    const startEur = res.starting_balance?.eur ?? 0;
                    const endEth = res.ending_balance?.eth ?? 0;
                    const endEur = res.ending_balance?.eur ?? 0;

                    startBalanceEl.textContent = `${formatNumberForDisplay(startEth)} ETH (${formatEuro(startEur)})`;
                    endBalanceEl.textContent = `${formatNumberForDisplay(endEth)} ETH (${formatEuro(endEur)})`;

                    const gasEth = res.total_gas_eth ?? 0;
                    const gasEur = res.total_gas_eur ?? 0;
                    gasEl.textContent = `${formatNumberForDisplay(gasEth)} ETH (${formatEuro(gasEur)})`;

                    const startTokens = res.starting_balance?.tokens ?? {};
                    const endTokens = res.ending_balance?.tokens ?? {};

                    const outgoingCount = Array.isArray(res.outgoing) ? res.outgoing.length : 0;
                    const incomingCount = Array.isArray(res.incoming) ? res.incoming.length : 0;

                    outgoingHeader.textContent = `Outgoing Transactions (${outgoingCount})`;
                    incomingHeader.textContent = `Incoming Transactions (${incomingCount})`;

                    const allContracts = [...new Set([...Object.keys(startTokens), ...Object.keys(endTokens)])];

                    function tokenValue(contract) {
                        const s = startTokens[contract] || {};
                        const e = endTokens[contract] || {};
                        const val = s.value_eur ?? e.value_eur;
                        return (val === 'unknown' || val === undefined || val === null) ? null : val;
                    }

                    allContracts.sort((a, b) => {
                        const aVal = tokenValue(a);
                        const bVal = tokenValue(b);
                        if (aVal === null && bVal !== null) return 1;
                        if (aVal !== null && bVal === null) return -1;
                        return 0;
                    });

                    tokensTableBody.innerHTML = '';

                    const ethDeltaBal = computeDelta(startEth, endEth);
                    const ethDeltaVal = computeDelta(startEur, endEur);

                    const ethRow = document.createElement('tr');
                    ethRow.innerHTML = `
                        <td><strong>ETH</strong> — native</td>
                        <td>${formatNumberForDisplay(startEth)}</td>
                        <td>${formatEuro(startEur)}</td>
                        <td>${formatNumberForDisplay(endEth)}</td>
                        <td>${formatEuro(endEur)}</td>
                        <td>${formatNumberForDisplay(ethDeltaBal)}</td>
                        <td>${formatEuro(ethDeltaVal)}</td>`;
                    tokensTableBody.appendChild(ethRow);

                    allContracts.forEach(contract=>{
                        const s = startTokens[contract] || {};
                        const e = endTokens[contract] || {};
                        const labelName = (s.name || s.symbol) || (e.name || e.symbol) || contract;
                        const label = `${labelName} — ${shortAddr(contract)}`;

                        const sBal = parseFloat(s.balance)||0;
                        const eBal = parseFloat(e.balance)||0;
                        const sValNum = parseFloat(s.value_eur)||0;
                        const eValNum = parseFloat(e.value_eur)||0;

                        const deltaBal = computeDelta(sBal, eBal);
                        const deltaVal = computeDelta(sValNum, eValNum);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${label}</td>
                            <td>${formatNumberForDisplay(sBal)}</td>
                            <td>${formatEuro(sValNum)}</td>
                            <td>${formatNumberForDisplay(eBal)}</td>
                            <td>${formatEuro(eValNum)}</td>
                            <td>${formatNumberForDisplay(deltaBal)}</td>
                            <td>${formatEuro(deltaVal)}</td>`;
                        tokensTableBody.appendChild(row);
                    });

                    if (fifoChecked && (res.total_holdings || res.sales)) {
                        fifoSalesContainer.style.display = 'block';
                        fifoSalesContainer.innerHTML = '<strong>FIFO Sales:</strong>';

                        const salesList = [];
                        if (Array.isArray(res.sales)) {
                            res.sales.forEach(s => salesList.push({ ...s }));
                        } else if (res.sales && typeof res.sales === 'object') {
                            for (const token in res.sales) {
                                (res.sales[token] || []).forEach(s => salesList.push({ token, ...s }));
                            }
                        }

                        const num = v => (v === undefined ? undefined : Number(v));

                        const makeTable = (title, headers) => {
                            const table = document.createElement('table');
                            table.style.width = '100%';
                            table.style.borderCollapse = 'collapse';
                            table.style.marginTop = '15px';
                            table.style.border = '1px solid #ccc';
                            table.innerHTML = `
                                <thead style="background:#f4f4f4;border-bottom:1px solid #ccc;">
                                    <tr>${headers.map(h => `<th style="padding:4px;border-bottom:1px solid #ccc;text-align:left;">${h}</th>`).join('')}</tr>
                                </thead>
                                <tbody></tbody>
                            `;
                            return table;
                        };

                        const salesTable = makeTable('FIFO Sales', [
                            'Token', 'Buy Datetime', 'Sell Datetime', 'Buy Price (EUR)', 'Sell Price (EUR)', 'Amount', 'Profit (EUR)'
                        ]);
                        fifoSalesContainer.appendChild(salesTable);
                        const salesBody = salesTable.querySelector('tbody');

                        salesList.sort((a, b) => num(a.timestamp_sell) - num(b.timestamp_sell));

                        for (const s of salesList) {
                            const buy = num(s.price_buy);
                            const sell = num(s.price_sell);
                            const amt = num(s.amount) || 0;
                            const buyVal = num(s.value_buy_eur) ?? (buy ? buy * amt : 0);
                            const sellVal = num(s.value_sell_eur) ?? (sell ? sell * amt : 0);
                            const profit = sellVal - buyVal;

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="padding:4px;border-bottom:1px solid #eee;">${s.token}</td>
                                <td style="padding:4px;border-bottom:1px solid #eee;">${formatTsWithTimezone(s.timestamp_buy, tz)}</td>
                                <td style="padding:4px;border-bottom:1px solid #eee;">${formatTsWithTimezone(s.timestamp_sell, tz)}</td>
                                <td style="padding:4px;border-bottom:1px solid #eee;">€${buy?.toFixed(4) ?? '-'}</td>
                                <td style="padding:4px;border-bottom:1px solid #eee;">€${sell?.toFixed(4) ?? '-'}</td>
                                <td style="padding:4px;border-bottom:1px solid #eee;">${amt.toFixed(6)}</td>
                                <td style="padding:4px;border-bottom:1px solid #eee;">€${profit.toFixed(4)}</td>
                            `;
                            salesBody.appendChild(row);
                        }

                        fifoSummaryContainer.style.display = 'block';
                        fifoSummaryBody.innerHTML = '';

                        const tokens = new Set(salesList.map(s => s.token));

                        for (const token of tokens) {
                            const soldRows = salesList.filter(s => s.token === token);
                            const soldAmt = soldRows.reduce((a, s) => a + (num(s.amount) || 0), 0);
                            if (soldAmt === 0) continue;

                            const soldVal = soldRows.reduce((a, s) => a + (num(s.value_sell_eur) || 0), 0);
                            const profit = soldRows.reduce((a, s) => {
                                const b = num(s.value_buy_eur);
                                const c = num(s.value_sell_eur);
                                return a + ((c && b) ? (c - b) : 0);
                            }, 0);

                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td style="padding:4px;border-bottom:1px solid #eee;">${token}</td>
                                <td style="padding:4px;border-bottom:1px solid #eee;">${soldAmt.toFixed(6)}</td>
                                <td style="padding:4px;border-bottom:1px solid #eee;">€${soldVal.toFixed(4)}</td>
                                <td style="padding:4px;border-bottom:1px solid #eee;">€${profit.toFixed(4)}</td>
                            `;
                            fifoSummaryBody.appendChild(row);
                        }

                        const totalProfit = Array.from(tokens).reduce((sum, token) => {
                            const soldRows = salesList.filter(s => s.token === token);
                            return sum + soldRows.reduce((a, s) => {
                                const b = num(s.value_buy_eur);
                                const c = num(s.value_sell_eur);
                                return a + ((c && b) ? (c - b) : 0);
                            }, 0);
                        }, 0);

                        const gasFeesEur = res.total_gas_eur ?? 0;
                        const totalWalletProfit = totalProfit - gasFeesEur;

                        const totalProfitRow = document.createElement('tr');
                        totalProfitRow.innerHTML = `
                            <td colspan="3" style="padding:4px;border-top:2px solid #000;font-weight:bold;">Total Profit</td>
                            <td style="padding:4px;border-top:2px solid #000;font-weight:bold;">€${totalProfit.toFixed(4)}</td>
                        `;
                        fifoSummaryBody.appendChild(totalProfitRow);

                        const gasFeesRow = document.createElement('tr');
                        gasFeesRow.innerHTML = `
                            <td colspan="3" style="padding:4px;font-weight:bold;">Gas Fees Paid</td>
                            <td style="padding:4px;font-weight:bold;">€${gasFeesEur.toFixed(4)}</td>
                        `;
                        fifoSummaryBody.appendChild(gasFeesRow);

                        const walletProfitRow = document.createElement('tr');
                        walletProfitRow.innerHTML = `
                            <td colspan="3" style="padding:4px;font-weight:bold;">Total Wallet Profit for Period</td>
                            <td style="padding:4px;font-weight:bold;">€${totalWalletProfit.toFixed(4)}</td>
                        `;
                        fifoSummaryBody.appendChild(walletProfitRow);
                    }

                    transactionsOutgoingEl.textContent = Array.isArray(res.outgoing) && res.outgoing.length ? JSON.stringify(res.outgoing, null, 2) : 'No outgoing transactions';
                    transactionsIncomingEl.textContent = Array.isArray(res.incoming) && res.incoming.length ? JSON.stringify(res.incoming, null, 2) : 'No incoming transactions';

                    eventsLogEl.textContent += 'Result received.\n';
                    eventsLogEl.scrollTop = eventsLogEl.scrollHeight;

                    evtSource.close();
                }
            } catch (parseErr) {
                eventsLogEl.textContent += 'Malformed message: ' + String(event.data) + '\n';
                eventsLogEl.scrollTop = eventsLogEl.scrollHeight;
            }
        };

        evtSource.onerror = function(){
            showToast('Failed to fetch wallet data');
            eventsLogEl.textContent += 'Connection error.\n';
            evtSource.close();
        };

    }catch(err){
        showToast('Network error');
        startBalanceEl.textContent='-';
        endBalanceEl.textContent='-';
        gasEl.textContent='-';
        eventsLogEl.textContent='No data';
        transactionsIncomingEl.textContent='No data';
        transactionsOutgoingEl.textContent='No data';
        tokensTableBody.innerHTML = '<tr><td colspan="7">No data</td></tr>';
        fifoSalesContainer.style.display='none';
        fifoSummaryContainer.style.display='none';
        console.error(err);
        showToast('Request failed');
    }
});

const aiPromptEl = document.getElementById('aiPrompt');
const aiResponseEl = document.getElementById('aiResponse');
const sendAiBtn = document.getElementById('sendAiBtn');

sendAiBtn.addEventListener('click', async () => {
    const prompt = aiPromptEl.value.trim();
    if (!prompt) return;

    aiResponseEl.textContent = 'Thinking...';

    try {
        const response = await fetch('/ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt, context: window.lastWalletResult || {} })
        });
        const data = await response.json();
        const text = data.response || 'No response';

        aiResponseEl.innerHTML = text
            .replace(/\n/g, '<br>')
            .replace(/^- /gm, '• ');

    } catch (err) {
        aiResponseEl.textContent = 'Error: ' + err.message;
    }
});

</script>
</body>
</html>
