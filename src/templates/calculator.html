<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wallet Calculator</title>
<style>
:root{
    --bg:#f0f2f5;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#4CAF50;
    --accent-hover:#137e14;
    --danger:#f44336;
}
html,body{height:100%;margin:0;}
body{
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:40px 24px;
}
.container{
    width:min(1600px,96%);
    max-width:1600px;
    background:var(--card);
    border-radius:12px;
    padding:36px;
    box-shadow:0 10px 30px rgba(16,24,40,0.08);
    display:flex;
    flex-direction:column;
    gap:24px;
    align-items:center;
}
h1{font-size:26px;margin:0;text-align:center;}
form{
    display:flex;
    flex-direction:column;
    gap:20px;
    width:100%;
    max-width:1000px;
    align-items:stretch;
}
input[type="text"], input[type="date"]{
    padding:16px;
    border-radius:12px;
    border:1px solid #ccc;
    font-size:16px;
    width:100%;
    max-width:800px;
    box-sizing:border-box;
}
button{
    padding:16px 0;
    border-radius:12px;
    border:0;
    background:var(--accent);
    color:#fff;
    font-weight:700;
    font-size:16px;
    cursor:pointer;
    width:100%;
    max-width:800px;
}
button:hover{background:var(--accent-hover);}
.results{
    display:flex;
    flex-direction:column;
    gap:16px;
    width:100%;
    max-width:1000px;
}
.results .transactions {
    max-height: 500px;
    width: 100%;
    overflow-y: auto;
    background: #111;
    color: #0f0;
    font-family: monospace;
    padding: 12px;
    border-radius: 12px;
    white-space: pre-wrap;
}
.tokens-table {
    width:100%;
    border-collapse: collapse;
    font-family: system-ui, Roboto, "Helvetica Neue", Arial, monospace;
    margin-top:10px;
}
.tokens-table th, .tokens-table td {
    border:1px solid #ddd;
    padding:8px 10px;
    text-align:left;
    vertical-align:top;
}
.tokens-table th {
    background:#f9f9f9;
    font-weight:700;
}
.toast{
    position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 20px;border-radius:12px;color:#fff;font-weight:700;display:none;z-index:1300;
}
.toast.error{background:var(--danger)}
.toast.success{background:var(--accent)}
.visually-hidden{
    position:absolute!important;
    height:1px;width:1px;
    overflow:hidden;clip:rect(1px,1px,1px,1px);
    white-space:nowrap;border:0;padding:0;margin:-1px;
}
</style>
</head>
<body>
<div class="container">
    <h1>Wallet Calculator</h1>
    <form id="walletForm">
        <label>
            <input type="text" name="wallet" placeholder="Wallet Address" required />
        </label>
        <label>
            <input type="date" name="start_date" required />
        </label>
        <label>
            <input type="date" name="end_date" required />
        </label>
        <button type="submit">Check Wallet</button>
    </form>

    <div class="results" id="results">
        <div><strong>Starting Balance:</strong> <span id="startBalance">-</span></div>
        <div><strong>Ending Balance:</strong> <span id="endBalance">-</span></div>
        <div><strong>Gas Used:</strong> <span id="gasUsed">-</span></div>

        <div><strong>Tokens:</strong></div>
        <table class="tokens-table" id="tokensTable" aria-describedby="tokens-table-desc">
            <caption id="tokens-table-desc" class="visually-hidden">Token balances — left column is start, right column is end</caption>
            <thead>
                <tr>
                    <th>Token (name — contract)</th>
                    <th>Start Balance</th>
                    <th>Start Value</th>
                    <th>End Balance</th>
                    <th>End Value</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div><strong>Transactions:</strong></div>
        <div class="transactions" id="transactions">No data</div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
const form = document.getElementById('walletForm');
const startBalanceEl = document.getElementById('startBalance');
const endBalanceEl = document.getElementById('endBalance');
const gasEl = document.getElementById('gasUsed');
const transactionsEl = document.getElementById('transactions');
const startTokensEl = document.getElementById('startTokens');
const endTokensEl = document.getElementById('endTokens');
const tokensTableBody = document.getElementById('tokensTable').querySelector('tbody');
const toastEl = document.getElementById('toast');

function showToast(msg,type='error',ms=2500){
    toastEl.textContent=msg;
    toastEl.className='toast '+(type==='success'?'success':'error');
    toastEl.style.display='block';
    setTimeout(()=> toastEl.style.display='none', ms);
}

function shortAddr(addr){
    if(!addr || typeof addr !== 'string') return addr || '';
    if(addr.length <= 12) return addr;
    return addr.slice(0,6) + '…' + addr.slice(-4);
}

function formatNumberForDisplay(v){
    if(v === undefined || v === null) return '-';
    const n = (typeof v === 'number') ? v : parseFloat(String(v));
    if(isNaN(n)) return String(v);
    if(Math.abs(n) < 0.000001) return n.toExponential();
    return n.toLocaleString(undefined, {maximumFractionDigits: 8});
}

function formatEuro(v){
    if(v === undefined || v === null) return '-';
    if(typeof v === 'number') return '€' + Number(v).toFixed(2);
    const parsed = parseFloat(String(v));
    if(!isNaN(parsed)) return '€' + parsed.toFixed(2);
    return String(v);
}

form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    startBalanceEl.textContent='Loading...';
    endBalanceEl.textContent='Loading...';
    gasEl.textContent='Loading...';
    transactionsEl.textContent='Loading...';
    tokensTableBody.innerHTML='<tr><td colspan="5">Loading...</td></tr>';

    const formData = new FormData(form);
    const params = new URLSearchParams(formData);

    try{
        const evtSource = new EventSource('/check?' + params.toString());
        transactionsEl.textContent='';

        evtSource.onmessage = function(event){
            const data = JSON.parse(event.data);
            if(data.type === 'log'){
                transactionsEl.textContent += data.msg + '\n';
                transactionsEl.scrollTop = transactionsEl.scrollHeight;
                return;
            }
            if(data.type === 'result'){
                const res = data.data;

                const startEth = res.starting_balance?.eth ?? 0;
                const startEur = res.starting_balance?.eur ?? 0;
                startBalanceEl.textContent = `${formatNumberForDisplay(startEth)} ETH (${formatEuro(startEur)})`;

                const endEth = res.ending_balance?.eth ?? 0;
                const endEur = res.ending_balance?.eur ?? 0;
                endBalanceEl.textContent = `${formatNumberForDisplay(endEth)} ETH (${formatEuro(endEur)})`;

                const gasEth = res.total_gas_eth ?? 0;
                const gasEur = res.total_gas_eur ?? 0;
                gasEl.textContent = `${formatNumberForDisplay(gasEth)} ETH (${formatEuro(gasEur)})`;

                if(startTokensEl) startTokensEl.textContent = JSON.stringify(res.starting_balance?.tokens ?? {});
                if(endTokensEl) endTokensEl.textContent = JSON.stringify(res.ending_balance?.tokens ?? {});

                const startTokens = res.starting_balance?.tokens ?? {};
                const endTokens = res.ending_balance?.tokens ?? {};

                const allContracts = [...new Set([...Object.keys(startTokens), ...Object.keys(endTokens)])];

                function tokenValue(contract) {
                    const s = startTokens[contract] || {};
                    const e = endTokens[contract] || {};
                    const val = s.value_eur ?? e.value_eur;
                    return (val === 'unknown' || val === undefined || val === null) ? null : val;
                }

                allContracts.sort((a, b) => {
                    const aVal = tokenValue(a);
                    const bVal = tokenValue(b);
                    if (aVal === null && bVal !== null) return 1;
                    if (aVal !== null && bVal === null) return -1;
                    return 0;
                });

                tokensTableBody.innerHTML = '';

                const ethRow = document.createElement('tr');
                ethRow.innerHTML = `
                    <td><strong>ETH</strong> — native</td>
                    <td>${formatNumberForDisplay(startEth)}</td>
                    <td>${formatEuro(startEur)}</td>
                    <td>${formatNumberForDisplay(endEth)}</td>
                    <td>${formatEuro(endEur)}</td>`;
                tokensTableBody.appendChild(ethRow);

                function renderTokenRow(contract){
                    const s = startTokens[contract] || {};
                    const e = endTokens[contract] || {};
                    const labelName = (s.name || s.symbol) || (e.name || e.symbol) || contract;
                    const label = `${labelName} — ${shortAddr(contract)}`;

                    const sBalance = formatNumberForDisplay(s.balance);
                    const eBalance = formatNumberForDisplay(e.balance);

                    const sVal = formatEuro(s.value_eur);
                    const eVal = formatEuro(e.value_eur);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${label}</td>
                        <td>${sBalance}</td>
                        <td>${sVal}</td>
                        <td>${eBalance}</td>
                        <td>${eVal}</td>`;
                    tokensTableBody.appendChild(row);
                }

                allContracts.forEach(renderTokenRow);

                if(Array.isArray(res.transactions) && res.transactions.length){
                    transactionsEl.textContent = JSON.stringify(res.transactions, null, 2);
                } else {
                    transactionsEl.textContent = 'No transactions';
                }

                evtSource.close();
            }
        };

        evtSource.onerror = function(){
            showToast('Failed to fetch wallet data');
            evtSource.close();
        };

    }catch(err){
        showToast('Network error');
        startBalanceEl.textContent='-';
        endBalanceEl.textContent='-';
        gasEl.textContent='-';
        transactionsEl.textContent='No data';
        console.error(err);
    }
});
</script>
</body>
</html>
